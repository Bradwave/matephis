<!DOCTYPE html>
<html lang="it">

<head>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="{{ site.title | default: site.heading }}" property="og:site_name" />
    <meta content="{{ site.description | default: 'Un blog di matematica e fisica' }}" property="og:description">
    <meta content="{{ site.url }}/about/" property="article:author">
    {%- if site.og_image -%}
    <meta property="og:image" content="{{ site.baseurl }}{{ site.og_image }}">
    {%- endif -%}
    {%- if page.title -%}
    <meta content="{{ page.title }}" property="og:title">
    <meta content="article" property="og:type">
    <meta content="{{ site.url }}{{ page.url }}" property="og:url">
    {%- else -%}
    <meta content="website" property="og:type">
    <meta content="{{ site.url }}{{ page.url }}" property="og:url">
    {%- endif -%}

    <title>{%- if page.title -%}{{ page.title }} - {%- endif -%}{{ site.heading }}</title>
    <link rel="canonical" href="{{site.url}}{{page.url}}" />
    {%- if site.apple_touch_icon -%}
    <link rel="apple-touch-icon" href="{{ site.baseurl }}{{ site.apple_touch_icon }}">
    {%- endif -%}
    {%- if site.favicon -%}
    <link rel="icon" href="{{ site.baseurl }}{{ site.favicon }}" type="image/svg+xml" sizes="any" />
    {%- endif -%}
    {%- if site.css_file -%}
    <link href="{{ site.baseurl }}{{ site.css_file }}?v=2.2" rel="stylesheet" media="all" class="default" />
    {%- else -%}
    <link href="{{ site.baseurl }}/assets/css/style.css?v=2.2" rel="stylesheet" media="all" class="default" />
    {%- endif -%}
    {%- if site.mathjax -%}
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
    {%- endif -%}

    <link rel="alternate" type="application/rss+xml" href="{{ site.url }}/feed.xml">
    <!--link rel="stylesheet" href="{{ '/assets/css/syntax.css' | relative_url }}"-->
</head>

<body>
    <div class="container">
        <div>
            {%- include Nav.html -%}

            {%- assign show_toc = true -%}
            {%- if page.toc == false -%}{%- assign show_toc = false -%}{%- endif -%}
            
            {%- assign show_sidebar = true -%}
            {%- if page.permalink == "/" or page.permalink == "/blog" or page.permalink == "/notes" -%}
                {%- assign show_sidebar = false -%}
            {%- endif -%}

            <div class="page-layout {% unless show_sidebar %}single-column{% endunless %}">
                <main>
                    <!-- Homepage Layout-->
                    {%- if page.permalink == "/" -%}
                    {%- if site.preferences.homepage.enabled -%}
                    <!--- Show content from index.md when homepage is enabled -->
                    {%- include Content.html -%}
                    {%- else -%}
                    <!--- Show content from notes.md + search + feed when homepage is disabled -->
                    <h1 class="page-title text-uppercase">{{page.title}}</h1>
                    {%- include Content.html -%}
                    {%- include Search.html -%}
                    {%- include Feed.html -%}
                    {%- endif -%}
                    {%- endif -%}

                    <!--- Notes Feed Layout-->
                    {%- if page.permalink == "/notes" -%}
                    <h1 class="page-title">{{page.title}}</h1>
                    {%- include Content.html -%}
                    {%- include Search.html -%}
                    {%- include Feed.html -%}
                    {%- endif -%}

                    <!--- Notes Layout-->
                    {%- if page.content-type == "notes" -%}
                    <h1 class="page-title">{{page.title}}</h1>
                    {%- include Content.html -%}
                    {%- if site.preferences.backlinks.enabled -%}
                    {%- include Backlinks.html -%}
                    {%- endif -%}
                    {%- endif -%}

                    <!--- Post Layout-->
                    {%- if page.content-type == "post" -%}
                    <h1 class="page-title">{{page.title}}</h1>
                    {%- include Content.html -%}
                    {%- if site.preferences.backlinks.enabled -%}
                    {%- include Backlinks.html -%}
                    {%- endif -%}
                    {%- endif -%}

                    <!--- Static Page Layout-->
                    {%- if page.content-type == "static" -%}
                    <h1 class="page-title">{{page.title}}</h1>
                    {%- include Content.html -%}
                    {%- endif -%}

                    <!--- Blog Feed Layout-->
                    {%- if page.permalink == "/blog" -%}
                    <div class="related-wrapper">
                        {% assign post_items = site.posts | sort: "date" | reverse %}
                        {% for post_items in post_items %}
                        {%- if post_items.feed == "show" -%}
                        <div class="notelist-feed">
                            <a href="{{ site.baseurl }}{{post_items.url}}">
                                <p>{{ post_items.title }}</p>
                            </a>
                        </div>
                        {%- endif -%}
                        {%- endfor -%}
                    </div>
                    {%- endif -%}
                </main>

                <!-- Sidebar TOC & Related -->
                {% if show_sidebar %}
                <aside class="sidebar">
                    {% if show_toc %}
                    <div class="sidebar-toc">
                        <h4>Indice</h4>
                        <ul id="toc-list">
                            <!-- JS will populate this -->
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Related Pages by Tag -->
                    {% assign excluded_tags = "attivit√†,esercizi,facsimile" | split: "," %}
                    {% assign found_related = false %}
                    
                    <div class="sidebar-related">
                        <h4>Correlati</h4>
                        <ul>
                            {% assign max_related = 5 %}
                            {% assign count = 0 %}
                            
                            <!-- Check Notes and Posts -->
                            {% assign all_docs = site.posts | concat: site.notes %}
                            
                            {% for doc in all_docs %}
                                {% if doc.url == page.url %}{% continue %}{% endif %}
                                
                                {% assign common_tags = false %}
                                {% for tag in doc.tags %}
                                    {% unless excluded_tags contains tag %}
                                        {% if page.tags contains tag %}
                                            {% assign common_tags = true %}
                                            {% break %}
                                        {% endif %}
                                    {% endunless %}
                                {% endfor %}
                                
                                {% if common_tags and count < max_related %}
                                    <li><a href="{{ site.baseurl }}{{ doc.url }}">{{ doc.title }}</a></li>
                                    {% assign count = count | plus: 1 %}
                                    {% assign found_related = true %}
                                {% endif %}
                            {% endfor %}
                            
                            {% unless found_related %}
                                <li style="font-style: italic; opacity: 0.6; font-size: 0.85em;">Nessuna pagina correlata.</li>
                            {% endunless %}
                        </ul>
                    </div>
                </aside>
                {% endif %}
            </div>

            {%- include Footer.html -%}
            {%- include Lightbox.html -%}
            
            <script>
                // TOC Generator
                document.addEventListener('DOMContentLoaded', () => {
                    const tocList = document.getElementById('toc-list');
                    if (!tocList) return;

                    const headers = document.querySelectorAll('main h2, main h3');
                    if (headers.length === 0) {
                        const tocContainer = document.querySelector('.sidebar-toc');
                        if (tocContainer) tocContainer.style.display = 'none';
                        
                        const relatedContainer = document.querySelector('.sidebar-related');
                        if (relatedContainer) {
                            relatedContainer.style.marginTop = '0';
                            relatedContainer.style.paddingTop = '0';
                            relatedContainer.style.borderTop = 'none';
                        }
                        return;
                    }

                    headers.forEach((header, index) => {
                        // Ensure header has ID
                        if (!header.id) {
                            header.id = 'header-' + index;
                        }

                        const li = document.createElement('li');
                        li.className = header.tagName.toLowerCase();
                        
                        const a = document.createElement('a');
                        a.href = '#' + header.id;
                        a.textContent = header.textContent;
                        
                        li.appendChild(a);
                        tocList.appendChild(li);
                    });
                    
                    // Optional: Highlight active link on scroll (Spy)
                    // Simplified version
                     const observer = new IntersectionObserver(entries => {
                        entries.forEach(entry => {
                            const id = entry.target.getAttribute('id');
                            if (entry.intersectionRatio > 0) {
                                document.querySelectorAll('.sidebar-toc a').forEach(link => {
                                    link.classList.remove('active');
                                    if (link.getAttribute('href') === `#${id}`) {
                                        link.classList.add('active');
                                    }
                                });
                            }
                        });
                    }, { rootMargin: '-10% 0px -80% 0px' }); // Highlight when near top

                    headers.forEach(h => observer.observe(h));
                });
            </script>
        </div>
    </div>
    <script src="{{ site.baseurl }}/assets/js/matephis-plot.js"></script>
</body>

</html>